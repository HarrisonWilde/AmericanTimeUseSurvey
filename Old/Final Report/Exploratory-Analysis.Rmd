---
title: "Exploratory Analysis"
author: "Dan"
date: "20 November 2018"
output: pdf_document
---

```{r}
#notes
# - age rounding
# - -1 means blank, -2 means don't know, -3 means refused
###### Import #######

library(rio)    #package for tibble
ATUS_dataset <- import("Data and Resources/ATUS Activity Data/atussum_0317.csv", setclass = "tibble")    # import data raw as TIBBLE
ATUS_Respondent_file <- import("Data and Resources/ATUS Respondent File/atusresp_0317.csv", setclass = "tibble")


######## Tidy Data #########

library(dplyr) #mutate
library(zoo) #date
library(lubridate)
#use unique to check values as NA's not used
sum(is.na(ATUS_dataset))
#met cols combine
ATUS_Respondent_file$TUDIARYDATE <- as.Date(as.character(ATUS_Respondent_file$TUDIARYDATE), "%Y%m%d")
ATUS_dataset <- mutate(ATUS_dataset, TESEX = ifelse(TESEX == 1, "M", "F"), TUDIARYDATE = ATUS_Respondent_file$TUDIARYDATE)
ATUS_dataset <- mutate(ATUS_dataset, Met_Status = as.factor(pmax(GEMETSTA, GTMETSTA)))
ATUS_dataset <- select(ATUS_dataset, -one_of(c("GEMETSTA", "GTMETSTA")))

#factors
factor_columns <- c("PEEDUCA", "PEHSPNON", "PTDTRACE", "TELFS", "TEMJOT", "TESCHENR", "TESCHLVL", "TESEX", "TESPEMPNOT", "TRDPFTPT", "TRERNWA", "TRHOLIDAY", "TRSPFTPT", "TRSPPRES", "TUDIARYDAY", "TEHRUSLT")
ATUS_dataset[,factor_columns] <- lapply(ATUS_dataset[,factor_columns], factor)

for (i in 1:9){
  assign(paste0("tu0", i), ATUS_dataset[,grep(paste0("^t0", i), names(ATUS_dataset))])
  assign(paste0("tu0",i), rowSums(get(paste0("tu0",i))))
  ATUS_dataset <- bind_cols(ATUS_dataset, tu0 = get(paste0("tu0", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("tu0", i)
  assign(paste0("part_tu0", i), 100 * (get(paste0("tu0",i)) > 0))
  ATUS_dataset <- bind_cols(ATUS_dataset, part_tu0 = get(paste0("part_tu0", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("part_tu0", i)
}
for (i in c(10:16, 18)){
  assign(paste0("tu", i), ATUS_dataset[,grep(paste0("^t", i), names(ATUS_dataset))])
  assign(paste0("tu",i), rowSums(get(paste0("tu",i))))
  ATUS_dataset <- bind_cols(ATUS_dataset, tu = get(paste0("tu", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("tu", i)
  assign(paste0("part_tu", i), 100 * (get(paste0("tu",i)) > 0))
  ATUS_dataset <- bind_cols(ATUS_dataset, part_tu0 = get(paste0("part_tu", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("part_tu", i)
}
ATUS_data_minus_july <- filter(ATUS_dataset, month(TUDIARYDATE) != 7)

#remove columns with -1's, -3's, -4's

#remove full time vs part time as has -1 (66499)
Data_minus_columns <- select(ATUS_data_minus_july, -one_of("TRDPFTPT"))
#remove full time vs part time spouse as has -1 (112134)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRSPFTPT"))
#remove age of youngest child as has -1 (95663)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRYHHCHILD"))
#remove 2 jobs within last 7 days as has -1 (66499)
Data_minus_columns <- select(Data_minus_columns, -one_of("TEMJOT"))
#remove enrolled at high school etc as has -1 and -3 and also question about which (76179 and 158595)
Data_minus_columns <- select(Data_minus_columns, -one_of(c("TESCHENR", "TESCHLVL")))
#remove employment status of spouse as has -1 (82506)
Data_minus_columns <- select(Data_minus_columns, -one_of("TESPEMPNOT"))
#remove weekly earnings as has -1 (78897)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRERNWA"))
#remove total hours usually worked per week due to -1 and -4 for vary
Data_minus_columns <- select(Data_minus_columns, -one_of("TEHRUSLT"))

#remove rows with -1 or -3
Data_minus_rows <- ATUS_data_minus_july[apply(ATUS_data_minus_july, 1, function(row) all(row != -1)), ]

###### Initial Summary #########

library(reshape2)
melted_participation_data <- melt(select(Data_minus_columns, "TUYEAR", grep("^part_tu", names(Data_minus_columns))), id.vars="TUYEAR")
#Initial Summary
library(ggplot2)
part_summary_plot <- ggplot(melted_participation_data, aes(x=TUYEAR, y=value, color = variable)) + geom_smooth(se=FALSE)
print(part_summary_plot)

melted_data <- melt(select(Data_minus_columns, "TUYEAR", grep("^tu", names(Data_minus_columns))), id.vars="TUYEAR")
summary_plot <- ggplot(melted_data, aes(x=TUYEAR, y=value, color=variable)) + geom_smooth(se=FALSE)
print(summary_plot)


####### Weighted Means #########

Data_minus_columns_year_grouped <- Data_minus_columns %>% group_by(TUYEAR)

weighted_means <- as_tibble(data.frame(TUYEAR = 2003:2017))
for (i in 1:9){
  weighted_means <- full_join(weighted_means, summarise_at(Data_minus_columns_year_grouped, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  weighted_means <- full_join(weighted_means, summarise_at(Data_minus_columns_year_grouped, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
variance <- sapply(weighted_means, function(col) var(col))
percentage_change <- (weighted_means[15,]/weighted_means[1,] - 1)*100
Activity_year_measures <- bind_rows(variance, percentage_change)
Activity_year_measures <- cbind(as_tibble(data.frame(Measure = c("Variance", "Percentage Change"))), select(Activity_year_measures, -TUYEAR))

part_weighted_means <- as_tibble(data.frame(TUYEAR = 2003:2017))
for (i in 1:9){
  part_weighted_means <- full_join(part_weighted_means, summarise_at(Data_minus_columns_year_grouped, vars(paste0("part_tu0", i)), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_weighted_means <- full_join(part_weighted_means, summarise_at(Data_minus_columns_year_grouped, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
part_variance <- sapply(part_weighted_means, function(col) var(col))
part_percentage_change <- (part_weighted_means[15,]/part_weighted_means[1,] - 1)*100
part_Activity_year_measures <- bind_rows(part_variance, part_percentage_change)
part_Activity_year_measures <- cbind(as_tibble(data.frame(Measure = c("Variance", "Percentage Change"))), select(part_Activity_year_measures, -TUYEAR))


######### looking after non_household members (reference plotly bookmark on phone) (tu04) ##########
n <- nrow(Data_minus_columns)
library(splines)
tu04_summary_model <- glm(tu04 ~ ns(TUYEAR, knots = seq(2004, 2016, 2)), data = Data_minus_columns, 
              family = quasi(link = "log", variance = "mu^2"),
              mustart = rep(5, n)
)
ggplot(Data_minus_columns, aes(x=TUYEAR, y=tu04)) + geom_smooth(method = "glm", formula = y ~ ns(x, knots = seq(2004, 2016, 2)),
                                                                method.args = list(family = quasi(link = "log", variance = "mu^2"), 
                                                                                   mustart = rep(5, n)))
tu04_variables_model <- update(tu04_summary_model, . ~ . + TESEX + PEEDUCA + PEHSPNON + PTDTRACE + TEAGE + TELFS + TRCHILDNUM + TRHOLIDAY + TRSPPRES)

tu04_sex_model <- update(tu04_summary_model, . ~ -1 + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)))
tu04_sex_model_data <- as_tibble(data.frame(TUYEAR = rep(seq(2003, 2017, length.out = 1000), 2), TESEX = c(rep("M",1000), rep("F",1000))))
tu04_sex_predicted <- predict(tu04_sex_model, newdata = tu04_sex_model_data, type = "link", se = TRUE)
tu04_sex_predicted <-bind_cols(tu04_sex_model_data, 
                               as_tibble(data.frame(fitted = exp(tu04_sex_predicted$fit),
                                                    ymin = exp(tu04_sex_predicted$fit-1.128*tu04_sex_predicted$se.fit), #80%
                                                    ymax = exp(tu04_sex_predicted$fit+1.128*tu04_sex_predicted$se.fit))))
ggplot(Data_minus_columns, aes(x=TUYEAR, y=tu04)) + 
  geom_line(data = tu04_sex_predicted, aes(y=fitted, col=TESEX), size=1) +
  geom_ribbon(data = filter(tu04_sex_predicted, TESEX =="M"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1) + 
  geom_ribbon(data = filter(tu04_sex_predicted, TESEX =="F"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1)




part_tu04_summary_model <- glm(part_tu04 ~ ns(TUYEAR, knots = seq(2004, 2016, 2)), data = Data_minus_columns, 
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n))
part_tu04_sex_model <- update(part_tu04_summary_model, . ~ -1 + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)))
part_tu04_sex_model_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017, length.out = 1000), TESEX=as.factor(c("M", "F"))))
part_tu04_sex_predicted <- predict(part_tu04_sex_model, newdata = part_tu04_sex_model_data, type = "link", se = TRUE)
part_tu04_sex_predicted <-bind_cols(part_tu04_sex_model_data, 
                               as_tibble(data.frame(fitted = exp(part_tu04_sex_predicted$fit),
                                                    ymin = exp(part_tu04_sex_predicted$fit-1.128*part_tu04_sex_predicted$se.fit), #80%
                                                    ymax = exp(part_tu04_sex_predicted$fit+1.128*part_tu04_sex_predicted$se.fit))))
ggplot(Data_minus_columns, aes(x=TUYEAR, y=part_tu04)) + 
  geom_line(data = part_tu04_sex_predicted, aes(y=fitted, col=TESEX), size=1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="M"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1) + 
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="F"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1)


part_tu04_employ_sex_model <- update(part_tu04_summary_model, . ~ -1 + TESEX + TELFS + TELFS:TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)))
part_tu04_employ_sex_model_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017, length.out = 1000), TESEX=as.factor(c("M", "F")), TELFS=as.factor(1:5)))
part_tu04_employ_sex_predicted <- predict(part_tu04_employ_sex_model, newdata = part_tu04_employ_sex_model_data, type = "link", se = TRUE)
part_tu04_employ_sex_predicted <-bind_cols(part_tu04_employ_sex_model_data, 
                                    as_tibble(data.frame(fitted = exp(part_tu04_employ_sex_predicted$fit),
                                                         ymin = exp(part_tu04_employ_sex_predicted$fit-1.96*part_tu04_employ_sex_predicted$se.fit), #80%
                                                         ymax = exp(part_tu04_employ_sex_predicted$fit+1.96*part_tu04_employ_sex_predicted$se.fit))))
ggplot(Data_minus_columns, aes(x=TUYEAR, y=part_tu04)) + 
  geom_line(data = part_tu04_employ_sex_predicted, aes(y=fitted, linetype=TESEX, col=TELFS), size=1)

part_tu04_employ_sex_model_data2<- bind_rows(filter(part_tu04_employ_sex_model_data, TELFS == 3),
                                            filter(part_tu04_employ_sex_model_data, TELFS == 2, TESEX == "M"),
                                            filter(part_tu04_employ_sex_model_data, TELFS == 4, TESEX == "F"))
part_tu04_employ_sex_predicted2 <- predict(part_tu04_employ_sex_model, newdata = part_tu04_employ_sex_model_data2 , type = "link", se = TRUE)
part_tu04_employ_sex_predicted2 <-bind_cols(part_tu04_employ_sex_model_data2, 
                                           as_tibble(data.frame(fitted = exp(part_tu04_employ_sex_predicted2$fit),
                                                                ymin = exp(part_tu04_employ_sex_predicted2$fit-1.128*part_tu04_employ_sex_predicted2$se.fit), #80%
                                                                ymax = exp(part_tu04_employ_sex_predicted2$fit+1.128*part_tu04_employ_sex_predicted2$se.fit))))
freq_TELFS <- ftable(table(select(Data_minus_columns, TUYEAR, TESEX, TELFS)))
freq_TELFS[,] <- freq_TELFS[,]/rowSums(freq_TELFS)*100
freq_TELFS <- melt(freq_TELFS, id.vars = "TUYEAR")
names(freq_TELFS) <- c("TUYEAR", "TESEX", "TELFS", "Percentage")
freq_TELFS_filter <- filter(freq_TELFS, TELFS %in% c(3,4))

part_tu04_employ_sex_model_data3 <- as_tibble(expand.grid(TUYEAR=2003:2017, TESEX=as.factor(c("M", "F")), TELFS=as.factor(1:5)))
part_tu04_employ_sex_predicted3 <- predict(part_tu04_employ_sex_model, newdata = part_tu04_employ_sex_model_data3, type = "link", se = TRUE)
part_tu04_employ_sex_predicted3 <-bind_cols(part_tu04_employ_sex_model_data3, 
                                           as_tibble(data.frame(fitted = exp(part_tu04_employ_sex_predicted3$fit),
                                                                ymin = exp(part_tu04_employ_sex_predicted3$fit-1.128*part_tu04_employ_sex_predicted3$se.fit), #80%
                                                                ymax = exp(part_tu04_employ_sex_predicted3$fit+1.128*part_tu04_employ_sex_predicted3$se.fit))))
ggplot(Data_minus_columns, aes(x=TUYEAR, y=part_tu04)) + 
  geom_line(data = part_tu04_employ_sex_predicted3, aes(y=fitted, linetype=TESEX, col=TELFS), size=1)

part_tu04_employ_sex_model_data4<- filter(part_tu04_employ_sex_model_data3, TELFS %in% c(3,4))
part_tu04_employ_sex_predicted4 <- predict(part_tu04_employ_sex_model, newdata = part_tu04_employ_sex_model_data4 , type = "link", se = TRUE)
part_tu04_employ_sex_predicted4 <-bind_cols(part_tu04_employ_sex_model_data4, 
                                            as_tibble(data.frame(fitted = exp(part_tu04_employ_sex_predicted4$fit),
                                                                 ymin = exp(part_tu04_employ_sex_predicted4$fit-1.128*part_tu04_employ_sex_predicted4$se.fit), #80%
                                                                 ymax = exp(part_tu04_employ_sex_predicted4$fit+1.128*part_tu04_employ_sex_predicted4$se.fit))))
ggplot(Data_minus_columns) + 
  geom_bar(data=freq_TELFS_filter, aes(x=as.numeric(as.character(TUYEAR)), y=Percentage, fill=TELFS:TESEX), stat="identity", position = "dodge") + 
  geom_line(data = part_tu04_employ_sex_predicted4, aes(x=TUYEAR, y=0.6*fitted, linetype=TESEX, col=TELFS), size=1.3) +
  scale_y_continuous(sec.axis = sec_axis(~.*(1/0.6), name = "Spent any time at all caring for & helping nonhousehold members (%)")) + 
  scale_x_continuous(breaks = 2003:2017) + xlab("Year") + ylab("% of Corresponding Unemployment")

#weighted using actual data
weighted_part_tu04_employ_sex_model <- update(part_tu04_employ_sex_model, . ~ + TUFNWGTP)
weighted_part_tu04_employ_sex_model_data4<- filter(Data_minus_columns, TELFS %in% c(3,4))
weighted_part_tu04_employ_sex_predicted4 <- predict(part_tu04_employ_sex_model, newdata = weighted_part_tu04_employ_sex_model_data4 , type = "link", se = TRUE)
weighted_part_tu04_employ_sex_predicted4 <-bind_cols(weighted_part_tu04_employ_sex_model_data4, 
                                            as_tibble(data.frame(fitted = exp(weighted_part_tu04_employ_sex_predicted4$fit),
                                                                 ymin = exp(weighted_part_tu04_employ_sex_predicted4$fit-1.128*weighted_part_tu04_employ_sex_predicted4$se.fit), #80%
                                                                 ymax = exp(weighted_part_tu04_employ_sex_predicted4$fit+1.128*weighted_part_tu04_employ_sex_predicted4$se.fit))))
ggplot(Data_minus_columns) + 
  geom_bar(data=freq_TELFS_filter, aes(x=as.numeric(as.character(TUYEAR)), y=Percentage, fill=TELFS:TESEX), stat="identity", position = "dodge") + 
  geom_line(data = weighted_part_tu04_employ_sex_predicted4, aes(x=TUYEAR, y=0.6*fitted, linetype=TESEX, col=TELFS), size=1.3) +
  scale_y_continuous(sec.axis = sec_axis(~.*(1/0.6), name = "Spent any time at all caring for & helping nonhousehold members (%)")) + 
  scale_x_continuous(breaks = 2003:2017) + xlab("Year") + ylab("% of Corresponding Unemployment")

tu04_employ_sex_model <- update(tu04_summary_model, . ~ -1 + TESEX + TELFS + TELFS:TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)))
weighted_tu04_employ_sex_model <- update(tu04_employ_sex_model, . ~ + TUFNWGTP)
weighted_tu04_employ_sex_model_data<- filter(Data_minus_columns, TELFS %in% c(3,4))
weighted_tu04_employ_sex_predicted <- predict(tu04_employ_sex_model, newdata = weighted_tu04_employ_sex_model_data , type = "link", se = TRUE)
weighted_tu04_employ_sex_predicted <-bind_cols(weighted_tu04_employ_sex_model_data, 
                                                     as_tibble(data.frame(fitted = exp(weighted_tu04_employ_sex_predicted$fit),
                                                                          ymin = exp(weighted_tu04_employ_sex_predicted$fit-1.128*weighted_tu04_employ_sex_predicted$se.fit), #80%
                                                                          ymax = exp(weighted_tu04_employ_sex_predicted$fit+1.128*weighted_tu04_employ_sex_predicted$se.fit))))
ggplot(Data_minus_columns) + 
  geom_bar(data=freq_TELFS_filter, aes(x=as.numeric(as.character(TUYEAR)), y=Percentage, fill=TELFS:TESEX), stat="identity", position = "dodge") + 
  geom_line(data = weighted_tu04_employ_sex_predicted, aes(x=TUYEAR, y=0.6*fitted, linetype=TESEX, col=TELFS), size=1.3) +
  scale_y_continuous(sec.axis = sec_axis(~.*(1/0.6), name = "Time spent caring for & helping nonhousehold members")) + 
  scale_x_continuous(breaks = 2003:2017) + xlab("Year") + ylab("% of Corresponding Unemployment")
```

