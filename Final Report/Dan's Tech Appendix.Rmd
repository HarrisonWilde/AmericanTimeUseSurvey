---
title: "Exploratory Analysis"
author: "Dan"
date: "20 November 2018"
geometry: left=2cm, right=2cm, top=2cm, bottom=2cm
output: pdf_document
bibliography: Final-Report-References.bib
csl: ieee.csl
link-citations: yes
---

```{r Notes, echo=FALSE, message=FALSE}
# - Ages from 80-84 are rounded to 80 and those 85+ are rounded to 85
# - In the data -1 means blank, -2 means don't know, -3 means refused
```
The packages required for the analysis are loaded and installed if required

Load all of the required packages and install any that are missing.

```{r Load and, if neccessary, install the package first, echo=FALSE, message=FALSE}
if (!require("kableExtra")){
  install.packages("kableExtra")
  library("kableExtra")
} # To change kable options (https://www.rdocumentation.org/packages/kableExtra/versions/0.9.0)
if (!require("dplyr")){
  install.packages("dplyr")
  library("dplyr")
} # data manipulation (https://www.rdocumentation.org/packages/dplyr/versions/0.7.8)
if (!require("rio")){
  install.packages("rio")
  library("rio")
} # Allows us to use tibbles (https://www.rdocumentation.org/packages/rio/versions/0.5.10)
if (!require("zoo")){
  install.packages("zoo")
  library("zoo")
} # Allows us to use dates (https://www.rdocumentation.org/packages/zoo/versions/1.8-4)
if (!require("lubridate")){
  install.packages("lubridate")
  library("lubridate")
} # Allows us to use the function 'month' (https://www.rdocumentation.org/packages/lubridate/versions/1.7.4)
if (!require("reshape2")){
  install.packages("reshape2")
  library("reshape2")
} # Allows us to use the function 'melt' (https://www.rdocumentation.org/packages/reshape2/versions/1.4.3)
if (!require("ggplot2")){
  install.packages("ggplot2")
  library("ggplot2")
} # More control over plots (https://www.rdocumentation.org/packages/ggplot2/versions/3.1.0)
if (!require("knitr")){
  install.packages("knitr")
  library("knitr")
} # To create tables using kable (https://www.rdocumentation.org/packages/knitr/versions/1.20)
if (!require("splines")){
  install.packages("splines")
  library("splines")
} # To use spline curves for models (https://www.rdocumentation.org/packages/splines/versions/3.5.1)
if (!require("leaps")){
  install.packages("leaps")
  library("leaps")
} # To use best subsets for models (https://www.rdocumentation.org/packages/leaps/versions/3.0)
if (!require("modEvA")){
  install.packages("modEvA")
  library("modEvA")
} # To calculate D-Squared (https://www.rdocumentation.org/packages/modEvA/versions/1.3.2)
if (!require("geojsonio")){
  install.packages("geojsonio")
  library("geojsonio")
} # To read a .geojson file into R to different types for map use (https://www.rdocumentation.org/packages/geojsonio/versions/0.6.0)
if (!require("openintro")){
  install.packages("openintro")
  library("openintro")
} # To convert state abbreviations to state names (https://www.rdocumentation.org/packages/openintro/versions/1.7.1)
if (!require("broom")){
  install.packages("broom")
  library("broom")
} # To tidy and foritify the data into a dataframe for map use (https://www.rdocumentation.org/packages/broom/versions/0.5.0)
if (!require("rgeos")){
  install.packages("rgeos")
  library("rgeos")
} # To calculate the centre of each state for map use (https://www.rdocumentation.org/packages/rgeos/versions/0.4-2)
```

2 key conclusions are mentioned in the report. The code below shows the methods used to reach these conclusions. Both follow the structure of Exploratory Analysis, Validation and then a final plot using all the data, excluding July.

# The Compelling Change in Caring for & Helping Non-HH Members

## Exploratory Data Analysis

The data used for the analyis is imported and tidied.

Import the datasets required from the ATUS [@ATUS] corpus of data. Summary and CPS files are used primarily.

```{r Import Data, echo=FALSE, message=FALSE, cache=TRUE}
ATUS.SUM <- import("atussum_0317.csv", setclass = "tibble")    # import raw summary data as TIBBLE
ATUS.CPS <- import('atuscps_0317.csv', setclass = "tibble") # import CPS data as TIBBLE for geographical data use
```

```{r Tidying the Data, echo=FALSE, message=FALSE, cache=TRUE}
# Check there are no other NA's other than those in format explained in the notes
NA_check <- sum(is.na(ATUS.SUM))

# Add date from respondent file and change Sex values to M and F instead of 1 and 2
ATUS.SUM <- mutate(ATUS.SUM, TESEX = ifelse(TESEX == 1, "M", "F"))
# Create a diary date column based off of the unique ID
ATUS.SUM$TUDIARYDATE <- as.Date(paste0(substr(ATUS.SUM$TUCASEID, 1, 6), '01'), "%Y%m%d")


# A change of variable name in this period leads to missing values so we merge these 2 variables
ATUS_dataset <- mutate(ATUS.SUM, Met_Status = as.factor(pmax(GEMETSTA, GTMETSTA)))
ATUS_dataset <- select(ATUS_dataset, -one_of(c("GEMETSTA", "GTMETSTA")))

# Set suitable variables as factors
factor_columns <- c("PEEDUCA", "PEHSPNON", "PTDTRACE", "TELFS", "TEMJOT", "TESCHENR", "TESCHLVL", "TESEX", "TESPEMPNOT", "TRDPFTPT", "TRERNWA", "TRHOLIDAY", "TRSPFTPT", "TRSPPRES", "TUDIARYDAY", "TEHRUSLT")
ATUS_dataset[,factor_columns] <- lapply(ATUS_dataset[,factor_columns], factor)

# Create time spent and participation columns with the 17 Categories
for (i in 1:9){
  assign(paste0("tu0", i), ATUS_dataset[,grep(paste0("^t0", i), names(ATUS_dataset))])
  assign(paste0("tu0",i), rowSums(get(paste0("tu0",i))))
  ATUS_dataset <- bind_cols(ATUS_dataset, tu0 = get(paste0("tu0", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("tu0", i)
  assign(paste0("part_tu0", i), 100 * (get(paste0("tu0",i)) > 0))
  ATUS_dataset <- bind_cols(ATUS_dataset, part_tu0 = get(paste0("part_tu0", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("part_tu0", i)
}
for (i in c(10:16, 18)){
  assign(paste0("tu", i), ATUS_dataset[,grep(paste0("^t", i), names(ATUS_dataset))])
  assign(paste0("tu",i), rowSums(get(paste0("tu",i))))
  ATUS_dataset <- bind_cols(ATUS_dataset, tu = get(paste0("tu", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("tu", i)
  assign(paste0("part_tu", i), 100 * (get(paste0("tu",i)) > 0))
  ATUS_dataset <- bind_cols(ATUS_dataset, part_tu0 = get(paste0("part_tu", i)))
  names(ATUS_dataset)[ncol(ATUS_dataset)] <- paste0("part_tu", i)
}

# The data is split for use in exploratory analysis, verification and then finally plotting with almost all the data
ATUS_training_data <- filter(ATUS_dataset, month(TUDIARYDATE) %in% c(2,4,6,8,10,12))
ATUS_validation_data <- filter(ATUS_dataset, month(TUDIARYDATE) %in% c(1,3,5,7,9,11))
ATUS_plotting_data <- filter(ATUS_dataset, month(TUDIARYDATE) != 7)

# Remove columns with -1's, -3's, -4's. We do this instead of removing rows as we would only be left with 1431 observations

#remove full time vs part time as has -1 (35304 times)
Data_minus_columns <- select(ATUS_training_data, -one_of("TRDPFTPT"))
#remove full time vs part time spouse as has -1 (59784 times)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRSPFTPT"))
#remove age of youngest child as has -1 (51103 times)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRYHHCHILD"))
#remove 2 jobs within last 7 days as has -1 (35304 times)
Data_minus_columns <- select(Data_minus_columns, -one_of("TEMJOT"))
#remove enrolled at high school etc as has -1 and -3 and also question about which (40739 and 84653 times)
Data_minus_columns <- select(Data_minus_columns, -one_of(c("TESCHENR", "TESCHLVL")))
#remove employment status of spouse as has -1 (43791 times)
Data_minus_columns <- select(Data_minus_columns, -one_of("TESPEMPNOT"))
#remove weekly earnings as has -1 (41936 times)
Data_minus_columns <- select(Data_minus_columns, -one_of("TRERNWA"))
#remove total hours usually worked per week due to -1 and -4 for vary
Data_minus_columns <- select(Data_minus_columns, -one_of("TEHRUSLT"))
```

The weighed means for each year are calculated for the 17 activity groups, both in minuted and % participation

```{r Weighted Means, echo=FALSE, message=FALSE, cache=TRUE}
# group the data by Year
Data_minus_columns_year_grouped <- Data_minus_columns %>% group_by(TUYEAR)

# Create tibbles for weighted means, for each year, for both time spent and partipation %
weighted_means_data <- as_tibble(data.frame(TUYEAR = 2003:2017))
for (i in 1:9){
  weighted_means_data <- full_join(weighted_means_data, summarise_at(Data_minus_columns_year_grouped, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  weighted_means_data <- full_join(weighted_means_data, summarise_at(Data_minus_columns_year_grouped, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_weighted_means_data <- as_tibble(data.frame(TUYEAR = 2003:2017))
for (i in 1:9){
  part_weighted_means_data <- full_join(part_weighted_means_data, summarise_at(Data_minus_columns_year_grouped, vars(paste0("part_tu0", i)), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_weighted_means_data <- full_join(part_weighted_means_data, summarise_at(Data_minus_columns_year_grouped, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
```

An overall summary of the actvity groups is created by the code below. It shows we need to look deeper to find interesting changes.

```{r Initial Summary Data, echo=FALSE, message=FALSE, cache=TRUE}
melted_participation_data <- melt(select(part_weighted_means_data, "TUYEAR", grep("^part_tu", names(part_weighted_means_data))), id.vars="TUYEAR")
melted_data <- melt(select(weighted_means_data, "TUYEAR", grep("^tu", names(weighted_means_data))), id.vars="TUYEAR")
```

```{r Initial Summary Plots, echo=FALSE, message=FALSE, cache=TRUE}
part_summary_plot <- ggplot(melted_participation_data, aes(x=TUYEAR, y=value, color = variable)) + geom_smooth(se=FALSE)
summary_plot <- ggplot(melted_data, aes(x=TUYEAR, y=value, color=variable)) + geom_smooth(se=FALSE)
```

```{r Printing Summary Plots, eval=FALSE, echo=FALSE, message=FALSE, cache=TRUE}
print(part_summary_plot)
print(summary_plot)
```

To get an better idea of which variables changed the most over the period, tables containing the percentage change from 2003 to 2017 and the variance over the period is created.

```{r Weighted Means Variance and Percentage Change, echo=FALSE, cache=TRUE}
variance <- sapply(weighted_means_data, function(col) var(col))
percentage_change <- (weighted_means_data[15,]/weighted_means_data[1,] - 1)*100
Activity_year_measures <- bind_rows(variance, percentage_change)
Activity_year_measures <- bind_cols(as_tibble(data.frame(Measure = c("Variance", "% Change"))), select(Activity_year_measures, -TUYEAR))

part_variance <- sapply(part_weighted_means_data, function(col) var(col))
part_percentage_change <- (part_weighted_means_data[15,]/part_weighted_means_data[1,] - 1)*100
part_Activity_year_measures <- bind_rows(part_variance, part_percentage_change)
part_Activity_year_measures <- bind_cols(as_tibble(data.frame(Measure = c("Variance", "% Change"))), select(part_Activity_year_measures, -TUYEAR))
```

```{r Weighted Means Variance and Percentage Change Table, echo=FALSE, cache=TRUE}
kable_names <- "Measure"
for (i in 1:9){
  kable_names <- c(kable_names, paste0("tu0", i))
}
for (i in c(10:16, 18)){
  kable_names <- c(kable_names, paste0("tu", i))
}
names(part_Activity_year_measures) <- kable_names
part_Activity_year_measures_values <- select(part_Activity_year_measures, -"Measure") %>% mutate(row_n = 1:n()) %>% select_if(function(x) any(x > 0.5 & .$row_n == 1)) %>% select_if(function(x) any(abs(x) > 10 & .$row_n == 2))
part_Activity_year_measures_values <- part_Activity_year_measures_values %>% mutate(row_n = 1:n()) %>% select_if(function(x) any(abs(x) > 10 & .$row_n == 2))
part_Activity_year_measures <- bind_cols(select(part_Activity_year_measures, "Measure"), part_Activity_year_measures_values)
part_tu03_kable <- kable(part_Activity_year_measures, caption = "Change in Participation of Activities", booktabs = T, digits = 2)
kable_styling(part_tu03_kable, full_width = T, latex_options = c("striped", "hold_position"))
```

Best subsets regression on a linear model is performed to estimate which variables have the largest effect on tu04 paticipation %.

```{r Best Subsets, include=FALSE, cache=TRUE}
best_subsets <- regsubsets(part_tu04~TUYEAR + TESEX + PEEDUCA + PEHSPNON + PTDTRACE + TEAGE + TELFS + TRCHILDNUM + TRHOLIDAY + TRSPPRES, data = Data_minus_columns, nvmax = 3, force.in = c(1))
```

A summary spline curve glm model with log link and multiplicative errors is fitted to show the change in tu04 over the period.

```{r part_tu04 Summary Model, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
n1 <- nrow(part_weighted_means_data)
part_tu04_summary_model <- glm(part_tu04 ~ ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_weighted_means_data,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n1))
part_tu04_summary_model_data <- as_tibble(data.frame(TUYEAR=seq(2003, 2017, length.out = 1000)))
part_tu04_summary_predicted <- predict(part_tu04_summary_model,
                                       newdata = part_tu04_summary_model_data,
                                       type = "link", se = TRUE)
part_tu04_summary_predicted <-bind_cols(part_tu04_summary_model_data,
                               as_tibble(data.frame(fitted = exp(part_tu04_summary_predicted$fit),
                                                    ymin = exp(part_tu04_summary_predicted$fit-1.128*part_tu04_summary_predicted$se.fit), #80% confidence interval for ribbon
                                                    ymax = exp(part_tu04_summary_predicted$fit+1.128*part_tu04_summary_predicted$se.fit))))
part_tu04_summary_plot <- ggplot(part_weighted_means_data, aes(x=TUYEAR, y=part_tu04)) +
  geom_line(data = part_tu04_summary_predicted, aes(y=fitted), size=1) +
  geom_ribbon(data = part_tu04_summary_predicted, aes(y=fitted, ymin=ymin, ymax=ymax), alpha=0.1)
```

```{r part_tu04 Summary Plot, message=FALSE, eval=FALSE, echo=FALSE, cache=TRUE}
print(part_tu04_summary_plot)
```

Best subsets showed that sex and number of household children have the largest effect on tu04 participation %. Therefore tu04 participation % is first broken down by sex. Therefore new weighted means are calculated.

```{r Sex Weighted Means, echo=FALSE, message=FALSE, cache=TRUE}
Data_minus_columns_year_sex_grouped <- Data_minus_columns %>% group_by(TUYEAR, TESEX)

sex_weighted_means_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  sex_weighted_means_data <- full_join(sex_weighted_means_data, summarise_at(Data_minus_columns_year_sex_grouped, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_weighted_means_data <- full_join(sex_weighted_means_data, summarise_at(Data_minus_columns_year_sex_grouped, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_weighted_means_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  part_sex_weighted_means_data <- full_join(part_sex_weighted_means_data, summarise_at(Data_minus_columns_year_sex_grouped, vars((paste0("part_tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_weighted_means_data <- full_join(part_sex_weighted_means_data, summarise_at(Data_minus_columns_year_sex_grouped, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
```

A new model is built to take account of this split.

```{r part_tu04 Sex Model, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
n2 <- nrow(part_sex_weighted_means_data)
part_tu04_sex_model <- glm(part_tu04 ~ -1 + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_weighted_means_data,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n2))
part_tu04_sex_model_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017, length.out = 1000), TESEX=as.factor(c("M", "F"))))
part_tu04_sex_predicted <- predict(part_tu04_sex_model, newdata = part_tu04_sex_model_data, type = "link", se = TRUE)
part_tu04_sex_predicted <-bind_cols(part_tu04_sex_model_data,
                               as_tibble(data.frame(fitted = exp(part_tu04_sex_predicted$fit),
                                                    ymin = exp(part_tu04_sex_predicted$fit-1.128*part_tu04_sex_predicted$se.fit), #80% confidence interval
                                                    ymax = exp(part_tu04_sex_predicted$fit+1.128*part_tu04_sex_predicted$se.fit))))
part_tu04_sex_plot <- ggplot(part_sex_weighted_means_data, aes(x=TUYEAR, y=part_tu04)) +
  geom_line(data = part_tu04_sex_predicted, aes(y=fitted, col=TESEX), size=1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="M"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="F"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1)
```


```{r part_tu04 Sex Plot, message=FALSE, eval=FALSE, echo=FALSE, cache=TRUE}
print(part_tu04_sex_plot) # print of the new model's plot
```

Weighted means for the number of household children for each group of people and year are calculated in order to see the change over the period.  A bar chart of these weighted mean number of household children is added to plot.

```{r TRCHILDNUM Weighted Means, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
sex_weighted_means_TRCHILDNUM <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  sex_weighted_means_TRCHILDNUM <- full_join(sex_weighted_means_TRCHILDNUM, summarise_at(Data_minus_columns_year_sex_grouped, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_weighted_means_TRCHILDNUM <- full_join(sex_weighted_means_TRCHILDNUM, summarise_at(Data_minus_columns_year_sex_grouped, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_weighted_means_TRCHILDNUM <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  part_sex_weighted_means_TRCHILDNUM <- full_join(part_sex_weighted_means_TRCHILDNUM, summarise_at(Data_minus_columns_year_sex_grouped, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_weighted_means_TRCHILDNUM <- full_join(part_sex_weighted_means_TRCHILDNUM, summarise_at(Data_minus_columns_year_sex_grouped, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}

part_tu04_sex_TRCHILDNUM_plot <- ggplot(part_sex_weighted_means_data, aes(x=TUYEAR, y=part_tu04)) +
  geom_bar(data=part_sex_weighted_means_TRCHILDNUM, aes(x=as.numeric(as.character(TUYEAR)), y=TRCHILDNUM, fill=TESEX), stat="identity", position = "dodge", width = 0.8, alpha = 0.3) +
  geom_smooth(method = "lm", data=part_sex_weighted_means_TRCHILDNUM, aes(x=as.numeric(as.character(TUYEAR)), y=TRCHILDNUM, col=TESEX), se=FALSE, linetype="dashed", size=1.5) +
  geom_line(data = part_tu04_sex_predicted, aes(x=TUYEAR, y=0.1*fitted, col=TESEX), size=1.3) +
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="M"), aes(y=0.1*fitted, ymin=0.1*ymin, ymax=0.1*ymax),alpha=0.1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted, TESEX =="F"), aes(y=0.1*fitted, ymin=0.1*ymin, ymax=0.1*ymax),alpha=0.1) +
  scale_y_continuous(sec.axis = sec_axis(~.*(1/0.1), name = "Spent any time at all caring for & \n helping nonhousehold members (%) \n")) +
  scale_x_continuous(breaks = seq(2003,2017,2)) + xlab("Year") + ylab("Average number of children") + labs(color="Sex", fill="Sex") + theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))
```

The suitability of the model is checked using an F test. It shows that is a significant improvement over the original model.

```{r Suitability of the model, echo=FALSE, cache=TRUE}
part_tu04_summary_model_anova <- glm(part_tu04 ~ ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_weighted_means_data, family = quasi(link = "log", variance = "mu^2"),
                              mustart = rep(5, n2))
ANOVA_for_sex <- anova(part_tu04_summary_model_anova, part_tu04_sex_model, test="F")
```

The final plot is printed.

```{r part_tu04 Sex Plot with Number of Children, message=FALSE, echo=FALSE, fig.height=4, cache=TRUE}
print(part_tu04_sex_TRCHILDNUM_plot)
```

The conclusion from the EDA in regards to the participation % for tu04 is informally tested by creating a simpler linear model which when tested shows that the coefficient for Year is < 0 and therefore confirms the belief.

```{r Linear model for the plot, eval=TRUE, echo=FALSE, message=FALSE, cache=TRUE}
part_tu04_sex_linear_model <- lm(data=part_sex_weighted_means_data, part_tu04~TUYEAR + TESEX)
part_tu04_sex_linear_model_summary <- summary(part_tu04_sex_linear_model)
Year_t <- coefficients(part_tu04_sex_linear_model_summary)[2,3]
lm_p_value <- pt(Year_t, part_tu04_sex_linear_model$df, lower=TRUE)
```

In order to check there is a link between the number of household children a new model must be produced which includes this as an explanatory variable. The code below builds this model

```{r Adding TRCHILDNUM to model, echo=FALSE, message=FALSE, cache=TRUE}
#note we have only 1439 respondents with TRCHILDNUM>4 so we set these to 4 so that the algorithm converges.
Data_minus_columns_year_sex_child_grouped <- Data_minus_columns
Data_minus_columns_year_sex_child_grouped <- mutate(Data_minus_columns_year_sex_child_grouped, TRCHILDNUM = ifelse(TRCHILDNUM >4, 4, TRCHILDNUM)) %>% group_by(TUYEAR, TESEX, TRCHILDNUM)

sex_child_weighted_means_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F")),  TRCHILDNUM = 0:4))
for (i in 1:9){
  sex_child_weighted_means_data <- full_join(sex_child_weighted_means_data, summarise_at(Data_minus_columns_year_sex_child_grouped, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_child_weighted_means_data <- full_join(sex_child_weighted_means_data, summarise_at(Data_minus_columns_year_sex_child_grouped, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_child_weighted_means_data <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F")),  TRCHILDNUM = 0:4))
for (i in 1:9){
  part_sex_child_weighted_means_data <- full_join(part_sex_child_weighted_means_data, summarise_at(Data_minus_columns_year_sex_child_grouped, vars((paste0("part_tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_child_weighted_means_data <- full_join(part_sex_child_weighted_means_data, summarise_at(Data_minus_columns_year_sex_child_grouped, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

n3 <- nrow(part_sex_child_weighted_means_data)
part_tu04_sex_child_model <- glm(part_tu04 ~ -1 + TRCHILDNUM + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_child_weighted_means_data,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n3))
```

A t test confirms that this variable is significant, implying there is a dependence.

```{r Testing the new model, eval=TRUE, echo=FALSE, message=FALSE, cache=TRUE}
sex_child_summary_for_t_test <- summary(part_tu04_sex_child_model)
sex_child_p_value <- coefficients(sex_child_summary_for_t_test)[1,4]
```

## Validation

In order to make formal conclusions based on the EDA we must hypotheses test them on the validation data.

The same tidying procedure is completed on the validation data.

```{r Validation Data Tidying, echo=FALSE, message=FALSE, cache=TRUE}
#remove full time vs part time as has -1
Data_minus_columns_validation <- select(ATUS_validation_data, -one_of("TRDPFTPT"))
#remove full time vs part time spouse as has -1
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TRSPFTPT"))
#remove age of youngest child as has -1
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TRYHHCHILD"))
#remove 2 jobs within last 7 days as has -1
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TEMJOT"))
#remove enrolled at high school etc as has -1 and -3 and also question about which
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of(c("TESCHENR", "TESCHLVL")))
#remove employment status of spouse as has -1
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TESPEMPNOT"))
#remove weekly earnings as has -1
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TRERNWA"))
#remove total hours usually worked per week due to -1 and -4 for vary
Data_minus_columns_validation <- select(Data_minus_columns_validation, -one_of("TEHRUSLT"))
```

Again, weighted means are calculated for men and women, for each year.

```{r Sex Weighted Means Validation, echo=FALSE, message=FALSE, cache=TRUE}
Data_minus_columns_year_sex_grouped_validation <- Data_minus_columns_validation %>% group_by(TUYEAR, TESEX)

sex_weighted_means_data_validation <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  sex_weighted_means_data_validation <- full_join(sex_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_grouped_validation, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_weighted_means_data_validation <- full_join(sex_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_grouped_validation, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_weighted_means_data_validation <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  part_sex_weighted_means_data_validation <- full_join(part_sex_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_grouped_validation, vars((paste0("part_tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_weighted_means_data_validation <- full_join(part_sex_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_grouped_validation, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
```

A linear model is fitted to the validation data and now a formal t test is completed. It confirms the proportion of American's who participate in caring for & helping non-household members has decreased over the period.

```{r Linear model for the plot Validation, eval=TRUE, echo=FALSE, message=FALSE, cache=TRUE}
part_tu04_sex_linear_model_validation <- lm(data=part_sex_weighted_means_data_validation, part_tu04~TUYEAR + TESEX)
part_tu04_sex_linear_model_summary_validation <- summary(part_tu04_sex_linear_model_validation)
Year_t_validation <- coefficients(part_tu04_sex_linear_model_summary_validation)[2,3]
lm_p_value_validation <- pt(Year_t_validation, part_tu04_sex_linear_model_validation$df, lower=TRUE)
```

Like with the EDA, a spline curve model is fitted.

```{r part_tu04 Sex Model Validation, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
n2_validation <- nrow(part_sex_weighted_means_data_validation)
part_tu04_sex_model_validation <- glm(part_tu04 ~ -1 + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_weighted_means_data_validation,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n2_validation))
part_tu04_sex_model_data_validation <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017, length.out = 1000), TESEX=as.factor(c("M", "F"))))
part_tu04_sex_predicted_validation <- predict(part_tu04_sex_model_validation, newdata = part_tu04_sex_model_data_validation, type = "link", se = TRUE)
part_tu04_sex_predicted_validation <-bind_cols(part_tu04_sex_model_data_validation,
                                               as_tibble(data.frame(fitted = exp(part_tu04_sex_predicted_validation$fit),
                                                                    ymin = exp(part_tu04_sex_predicted_validation$fit-1.128*part_tu04_sex_predicted_validation$se.fit), #80% confidence interval
                                                                    ymax = exp(part_tu04_sex_predicted_validation$fit+1.128*part_tu04_sex_predicted_validation$se.fit))))
part_tu04_sex_plot_validation <- ggplot(part_sex_weighted_means_data_validation, aes(x=TUYEAR, y=part_tu04)) +
  geom_line(data = part_tu04_sex_predicted_validation, aes(y=fitted, col=TESEX), size=1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted_validation, TESEX =="M"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted_validation, TESEX =="F"), aes(y=fitted, ymin=ymin, ymax=ymax),alpha=0.1)
```

Again, to check if the link between number of household children and tu04 participation % is significant it must be tested using an update of the model which includes the number of household children as an explanatory variable.

```{r Adding TRCHILDNUM to model Validation, echo=FALSE, message=FALSE, cache=TRUE}
Data_minus_columns_year_sex_child_grouped_validation <- Data_minus_columns_validation
Data_minus_columns_year_sex_child_grouped_validation <- mutate(Data_minus_columns_year_sex_child_grouped_validation, TRCHILDNUM = ifelse(TRCHILDNUM >4, 4, TRCHILDNUM)) %>% group_by(TUYEAR, TESEX, TRCHILDNUM)

sex_child_weighted_means_data_validation <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F")),  TRCHILDNUM = 0:4))
for (i in 1:9){
  sex_child_weighted_means_data_validation <- full_join(sex_child_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_child_grouped_validation, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_child_weighted_means_data_validation <- full_join(sex_child_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_child_grouped_validation, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_child_weighted_means_data_validation <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F")),  TRCHILDNUM = 0:4))
for (i in 1:9){
  part_sex_child_weighted_means_data_validation <- full_join(part_sex_child_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_child_grouped_validation, vars((paste0("part_tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_child_weighted_means_data_validation <- full_join(part_sex_child_weighted_means_data_validation, summarise_at(Data_minus_columns_year_sex_child_grouped_validation, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

n3_validation <- nrow(part_sex_child_weighted_means_data_validation)
part_tu04_sex_child_model_validation <- glm(part_tu04 ~ -1 + TRCHILDNUM + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_child_weighted_means_data_validation,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n3_validation))
```

The t-test is completed on the model

```{r Testing the new model Validation, eval=TRUE, echo=FALSE, message=FALSE, fig.height=4, cache=TRUE}
sex_child_summary_for_t_test_validation <- summary(part_tu04_sex_child_model_validation)
sex_child_p_value_validation <- coefficients(sex_child_summary_for_t_test_validation)[1,4]
```

```{r Plotting Data Tidying, echo=FALSE, message=FALSE, cache=TRUE}
#remove full time vs part time as has -1
Data_minus_columns_plotting <- select(ATUS_plotting_data, -one_of("TRDPFTPT"))
#remove full time vs part time spouse as has -1
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TRSPFTPT"))
#remove age of youngest child as has -1
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TRYHHCHILD"))
#remove 2 jobs within last 7 days as has -1
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TEMJOT"))
#remove enrolled at high school etc as has -1 and -3 and also question about which
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of(c("TESCHENR", "TESCHLVL")))
#remove employment status of spouse as has -1
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TESPEMPNOT"))
#remove weekly earnings as has -1
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TRERNWA"))
#remove total hours usually worked per week due to -1 and -4 for vary
Data_minus_columns_plotting <- select(Data_minus_columns_plotting, -one_of("TEHRUSLT"))
```

```{r Sex Weighted Means Plotting, echo=FALSE, message=FALSE, cache=TRUE}
Data_minus_columns_year_sex_grouped_plotting <- Data_minus_columns_plotting %>% group_by(TUYEAR, TESEX)

sex_weighted_means_data_plotting <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  sex_weighted_means_data_plotting <- full_join(sex_weighted_means_data_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars((paste0("tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_weighted_means_data_plotting <- full_join(sex_weighted_means_data_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars((paste0("tu", i))), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_weighted_means_data_plotting <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  part_sex_weighted_means_data_plotting <- full_join(part_sex_weighted_means_data_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars((paste0("part_tu0", i))), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_weighted_means_data_plotting <- full_join(part_sex_weighted_means_data_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars((paste0("part_tu", i))), funs(weighted.mean(., TUFNWGTP))))
}
```

```{r part_tu04 Sex Model Plotting, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
n2_plotting <- nrow(part_sex_weighted_means_data_plotting)
part_tu04_sex_model_plotting <- glm(part_tu04 ~ -1 + TESEX + TESEX:ns(TUYEAR, knots = seq(2004, 2016, 2)), data = part_sex_weighted_means_data_plotting,
                          family = quasi(link = "log", variance = "mu^2"),
                          mustart = rep(5, n2_plotting))
part_tu04_sex_model_data_plotting <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017, length.out = 1000), TESEX=as.factor(c("M", "F"))))
part_tu04_sex_predicted_plotting <- predict(part_tu04_sex_model_plotting, newdata = part_tu04_sex_model_data_plotting, type = "link", se = TRUE)
part_tu04_sex_predicted_plotting <-bind_cols(part_tu04_sex_model_data_plotting,
                                               as_tibble(data.frame(fitted = exp(part_tu04_sex_predicted_plotting$fit),
                                                                    ymin = exp(part_tu04_sex_predicted_plotting$fit-1.128*part_tu04_sex_predicted_plotting$se.fit), #80% confidence interval
                                                                    ymax = exp(part_tu04_sex_predicted_plotting$fit+1.128*part_tu04_sex_predicted_plotting$se.fit))))
```

```{r TRCHILDNUM Weighted Means Plotting, message=FALSE, echo=FALSE, warning=FALSE, cache=TRUE}
sex_weighted_means_TRCHILDNUM_plotting <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  sex_weighted_means_TRCHILDNUM_plotting <- full_join(sex_weighted_means_TRCHILDNUM_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  sex_weighted_means_TRCHILDNUM_plotting <- full_join(sex_weighted_means_TRCHILDNUM_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}

part_sex_weighted_means_TRCHILDNUM_plotting <- as_tibble(expand.grid(TUYEAR=seq(2003, 2017), TESEX=as.factor(c("M", "F"))))
for (i in 1:9){
  part_sex_weighted_means_TRCHILDNUM_plotting <- full_join(part_sex_weighted_means_TRCHILDNUM_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}
for (i in c(10:16, 18)){
  part_sex_weighted_means_TRCHILDNUM_plotting <- full_join(part_sex_weighted_means_TRCHILDNUM_plotting, summarise_at(Data_minus_columns_year_sex_grouped_plotting, vars(TRCHILDNUM), funs(weighted.mean(., TUFNWGTP))))
}

part_tu04_sex_TRCHILDNUM_plot_plotting <- ggplot(part_sex_weighted_means_data_plotting, aes(x=TUYEAR, y=part_tu04)) +
  geom_bar(data=part_sex_weighted_means_TRCHILDNUM_plotting, aes(x=as.numeric(as.character(TUYEAR)), y=TRCHILDNUM, fill=TESEX), stat="identity", position = "dodge", width = 0.8, alpha = 0.3) +
  geom_smooth(method = "lm", data=part_sex_weighted_means_TRCHILDNUM_plotting, aes(x=as.numeric(as.character(TUYEAR)), y=TRCHILDNUM, col=TESEX), se=FALSE, linetype="dashed", size=1.5) +
  geom_line(data = part_tu04_sex_predicted_plotting, aes(x=TUYEAR, y=0.1*fitted, col=TESEX), size=1.3) +
  geom_ribbon(data = filter(part_tu04_sex_predicted_plotting, TESEX =="M"), aes(y=0.1*fitted, ymin=0.1*ymin, ymax=0.1*ymax),alpha=0.1) +
  geom_ribbon(data = filter(part_tu04_sex_predicted_plotting, TESEX =="F"), aes(y=0.1*fitted, ymin=0.1*ymin, ymax=0.1*ymax),alpha=0.1) +
  scale_y_continuous(sec.axis = sec_axis(~.*(1/0.1), name = "Spent any time at all caring for & \n helping nonhousehold members (%) \n")) +
  scale_x_continuous(breaks = seq(2003,2017,2)) + xlab("Year") + ylab("Average number of children") + labs(color="Sex", fill="Sex") + theme(axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)), axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)))
```

```{r part_tu04 Sex Plot with Number of Children Plotting, message=FALSE, echo=FALSE, cache=TRUE}
print(part_tu04_sex_TRCHILDNUM_plot_plotting)
```








# How The Time Spent on Traditionally Gendered Activities has Converged as Gender Roles have Broken Down

Apply some reformatting to the data imported previously to better fit the exploratory analysis to be carried out. This includes the creation of a `TUBIRTHYEAR` feature to be used in separating people into different generations (Millenials, Baby Boomers etc.) represented by another feature called `TUGENERATION`. The `ATUS.CPS` dataset is then filtered to select regional data which can be joined to the dataset created so far for EDA.

```{r, cache=TRUE}
# Get birth year as a variable for purpose of classifying generation by subtratcting age from the year the datapoint was generated
ATUS.SUM$TUBIRTHYEAR <- ATUS.SUM$TUYEAR - ATUS.SUM$TEAGE
ATUS.SUM$TUGENERATION <- ifelse(ATUS.SUM$TUBIRTHYEAR < 1946, "Silent Generation", 
    ifelse(ATUS.SUM$TUBIRTHYEAR < 1965, "Baby Boomers",
        ifelse(ATUS.SUM$TUBIRTHYEAR < 1981, "Generation X", "Millennials")))

# Filter CPS down to just relevant variables. GEDSTFIPS is state, GEDIV is division and GEREG is region
ATUS.CPS.States <- select(ATUS.CPS, TUCASEID, GESTFIPS, GEDIV, GEREG)
ATUS.CPS.States <- distinct(ATUS.CPS.States)
```

Next, collections of variable representing traditional gender roles can be extracted. `ATUS_dataset` can then be subsetted to 'Gender.Roles.Data', including only relevant variables. Each of the collections of gender role variables can be appended to this dataset by summing over all of the relevant sub-variables. E.g. `t05` and all suffixes of this expression represent time spent working, so these can be summed over and collected under one variable in `Gender.Roles.Data$Working`.

```{r, cache=TRUE}
# Create a data frame from relevant variables within ATUS Summary
Gender.Roles.Data <- select(ATUS.SUM, TUCASEID, TESEX, TEAGE, TUFNWGTP, TUYEAR, TUDIARYDATE, TUGENERATION)

# Create variables to be added to a data frame with relevant gender activities 
Working <- ATUS.SUM[, grep("^t05", names(ATUS.SUM))]
House.Maintenance <- ATUS.SUM[, grep("^t0204", names(ATUS.SUM))]
Vehicle.Maintenance <- ATUS.SUM[, grep("^t0207", names(ATUS.SUM))]
Housework <- ATUS.SUM[, grep("^t0201", names(ATUS.SUM))]
Food.Preparation <- ATUS.SUM[, grep("^t0202", names(ATUS.SUM))] + ATUS.SUM$t070101 + ATUS.SUM$t070103
Childcare <- ATUS.SUM[, grep("^t03", names(ATUS.SUM))]

# Add in relevant categories
Gender.Roles.Data$Working <- rowSums(Working)
Gender.Roles.Data$House.Maintenance <- rowSums(House.Maintenance)
Gender.Roles.Data$Vehicle.Maintenance <- rowSums(Vehicle.Maintenance)
Gender.Roles.Data$Housework <- rowSums(Housework)
Gender.Roles.Data$Food.Preparation <- rowSums(Food.Preparation)
Gender.Roles.Data$Childcare <- rowSums(select(Childcare, t030101:t030399))

# Join this dataset with the CPS states info by unique id number of particiapnt
Gender.Roles.Data <- inner_join(Gender.Roles.Data, ATUS.CPS.States, by = 'TUCASEID')
```

This for-loop structure calculates weighted means for each possible combination of `variable`, `month`, `generation`, `region`, `year` and `sex`, which are to be used in modelling the data. The means are calculated for a demographic represented by one of these combinations and then attached to `Gender.Roles.Data` so that all of the individuals within that demographic / that conform to that combination have a weighted mean value for each variable.

This for loop also calculates a `Gender.Roles.Differences` data frame to store the differences between genders in the weighted mean values corresponding to each combination of `variable`, `month`, `generation` and `year`. These differences can then be used to perform statistical tests on the changes over the given period of data in the time use within each of the investigated variables to study how gender roles have changed.

```{r, cache=TRUE}
Gender.Roles.Differences <- data.frame('Year' = c(), 'Month' = c(), 'Variable' = c(), 'Generation' = c(), 'Difference' = c())
for (variable in c("Working", "House.Maintenance", "Vehicle.Maintenance", "Housework", "Food.Preparation", "Childcare")) {
    Gender.Roles.Data[,paste0('weighted.', variable)] <- 0
    for (generation in c("Silent Generation", "Baby Boomers", "Generation X", "Millennials")) {
        for (year in unique(Gender.Roles.Data$TUYEAR)) {
            for (month in unique(month(Gender.Roles.Data$TUDIARYDATE))) {
                for (sex in c("M", "F")) {
                    Filtered.Data <- filter(Gender.Roles.Data, TESEX == sex, TUYEAR == year, month(TUDIARYDATE) == month, TUGENERATION == generation)
                    bottom.sum <- sum(Filtered.Data$TUFNWGTP)
                    top.sum <- sum(Filtered.Data$TUFNWGTP * Filtered.Data[,variable])
                    weighted.values <- top.sum / bottom.sum
                    if (sex == 'M') m.weighted.values <- weighted.values
                    for (region in 1:4) {
                        Filtered.Regional.Data <- filter(Filtered.Data, GEREG == region)
                        bottom.sum <- sum(Filtered.Regional.Data$TUFNWGTP)
                        top.sum <- sum(Filtered.Regional.Data$TUFNWGTP * Filtered.Regional.Data[,variable])
                        weighted.regional.values <- top.sum / bottom.sum
                        Gender.Roles.Data[Gender.Roles.Data$TESEX == sex & Gender.Roles.Data$TUYEAR == year & month(Gender.Roles.Data$TUDIARYDATE) == month & Gender.Roles.Data$GEREG == region & Gender.Roles.Data$TUGENERATION == generation, paste0('weighted.', variable)] <- weighted.values
                    }
                }
                weighted.difference <- m.weighted.values - weighted.values
                Gender.Roles.Differences <- rbind(Gender.Roles.Differences, data.frame('Year' = year, 'Month' = month, 'Variable' = variable, 'Generation' = generation, 'Difference' = unique(weighted.difference)))
            }
        }
    }
}
```

Split the full dataset into `Train`, `Validate` and `Plotting` subsets, where `Train` includes all of the even-numbered months, `Validate` contains all of the odd-numbered months

```{r, cache=TRUE}
Gender.Roles.Train <- filter(Gender.Roles.Data, month(TUDIARYDATE) %% 2 == 0)
Gender.Roles.Validate <- filter(Gender.Roles.Data, month(TUDIARYDATE) %% 2 != 0)
Gender.Roles.Plotting <- filter(Gender.Roles.Data, month(TUDIARYDATE) != 7)
```

Below is a function which fits models on the passed dataset (one of the ones defined above) and then generates predictions with which plots can be made. This function is called multiple times below with appropriate `mu` start values passed to ensure the `glm()` algorithm converges. These plots are used extensively in the Gender Roles section of the report.

```{r, cache=TRUE}
# Make a vector containing each year as a Date object to be used in generating splines for the models
Dates = c()
for (i in 4:17) {
    if (i < 10) {
        Dates[i-3] <- paste(paste0("200", i), "01", "01", sep = "-")
    } else {
        Dates[i-3] <- paste(paste0("20", i), "01", "01", sep = "-")
    }
}

fit.models.and.plot <- function(Data, variable, mu) {
    # Start building models for the data
    n <- nrow(Data)
    # model1 <- glm(as.formula(paste0('weighted.',variable,' ~ ns(TUDIARYDATE, knots = (c(as.Date("2006-01-01"), as.Date("2009-01-01"), as.Date("2012-01-01"), as.Date("2015-01-01"))))')), data = Data, family = quasi(link = "log", variance = "mu^2"), mustart = rep(10, n))
    model1 <- glm(as.formula(paste0('weighted.',variable,' ~ ns(TUDIARYDATE)')), data = Data, family = quasi(link = "log", variance = "mu^2"), mustart = rep(mu, n))
    model2 <- update(model1, . ~ . + TESEX)
    # model3 <- update(model1, . ~ -1 + TESEX + TESEX:ns(TUDIARYDATE, knots = (c(as.Date('2006-01-01'), as.Date('2009-01-01'), as.Date('2012-01-01'), as.Date('2015-01-01')))))
    model3 <- update(model1, . ~ -1 + TESEX + TESEX:ns(TUDIARYDATE, knots = c(as.Date(Dates))))
    model4 <- update(model3, .~. + GEREG + GEREG:ns(TUDIARYDATE, knots = c(as.Date(Dates))))
    model5 <- update(model3, .~. + TUGENERATION + TUGENERATION:ns(TUDIARYDATE, knots = c(as.Date(Dates))))
    # model5 <- update(model3, .~. + GEREG + GEREG:ns(TUDIARYDATE, knots = c(as.Date(Dates))))
    # Use same method as in lab 5 to plot them

    # change the model number in the predict functions below for different models
    male.prediction <- predict.glm(model5, newdata = filter(Data, TESEX == 'M'), se = TRUE, type = "response")
    female.prediction <- predict.glm(model5, newdata = filter(Data, TESEX == 'F'), se = TRUE, type = "response")

    df <- data.frame(age = c(filter(Data, TESEX == 'M')$TEAGE, filter(Data, TESEX == 'F')$TEAGE), prediction = c(male.prediction$fit, female.prediction$fit), date = c(filter(Data, TESEX == 'M')$TUDIARYDATE, filter(Data, TESEX == 'F')$TUDIARYDATE), prediction_error = c(1.96*male.prediction$se.fit, 2*female.prediction$se.fit), type = c(filter(Data, TESEX == 'M')$TESEX, filter(Data, TESEX == 'F')$TESEX), region = c(filter(Data, TESEX == 'M')$GEREG, filter(Data, TESEX == 'F')$GEREG), generation = c(filter(Data, TESEX == "M")$TUGENERATION, filter(Data, TESEX == "F")$TUGENERATION))

    if (variable == 'Working' | variable == 'Childcare') {
        print(ggplot(filter(df, generation != "Silent Generation"), aes(x=date, y=prediction, colour=type)) +
        geom_line() +
        geom_ribbon(aes(ymin = prediction - prediction_error, ymax = prediction + prediction_error), alpha = 0.2, linetype = 0) + facet_wrap(~generation, nrow = 1) + labs(x = "Year", y = paste("Predicted",variable), title = paste("Trends in", tolower(gsub("[.]", " ", variable)), "for each generation"), caption = "Data Source: ATUS Survey"))
    } else {
        print(ggplot(df, aes(x=date, y=prediction, colour=type)) +
        geom_line() +
        geom_ribbon(aes(ymin = prediction - prediction_error, ymax = prediction + prediction_error), alpha = 0.2, linetype = 0) + facet_wrap(~generation, nrow = 1) + labs(x = "Year", y = paste("Predicted",variable), title = paste("Trends in", tolower(gsub("[.]", " ", variable)), "for each generation"), caption = "Data Source: ATUS Survey"))
    }
}
```

Generate plots for EDA to observe potential long-term trends over time for each of the chosen variables to investigate. `mu` values were experimented with once the data was first observe to roughly fall within the range of plotted values for each model.

```{r, cache=TRUE}
fit.models.and.plot(Gender.Roles.Train, 'Working', 250)
fit.models.and.plot(Gender.Roles.Train, 'House.Maintenance', 10)
fit.models.and.plot(Gender.Roles.Train, 'Vehicle.Maintenance', 10)
fit.models.and.plot(Gender.Roles.Train, 'Housework', 50)
fit.models.and.plot(Gender.Roles.Train, 'Food.Preparation', 60)
fit.models.and.plot(Gender.Roles.Train, 'Childcare', 50)
```

Generate plots to validate the trends obvserved above are consistent in the other half of the data.

```{r, cache=TRUE}
fit.models.and.plot(Gender.Roles.Validate, 'Working', 250)
fit.models.and.plot(Gender.Roles.Validate, 'House.Maintenance', 10)
fit.models.and.plot(Gender.Roles.Validate, 'Vehicle.Maintenance', 10)
fit.models.and.plot(Gender.Roles.Validate, 'Housework', 50)
fit.models.and.plot(Gender.Roles.Validate, 'Food.Preparation', 60)
fit.models.and.plot(Gender.Roles.Validate, 'Childcare', 50)
```

Generate plots on the entire dataset with the exception of July which is the directed month to exclude for this project. These plots are the ones included in the final report.

```{r, cache=TRUE}
# Plot found in the Working section
fit.models.and.plot(Gender.Roles.Plotting, 'Working', 250)
fit.models.and.plot(Gender.Roles.Plotting, 'House.Maintenance', 10)
fit.models.and.plot(Gender.Roles.Plotting, 'Vehicle.Maintenance', 10)
# Plot found in the Housework section
fit.models.and.plot(Gender.Roles.Plotting, 'Housework', 50)
# Plot found in the Food Preparation section
fit.models.and.plot(Gender.Roles.Plotting, 'Food.Preparation', 60)
# Plot found in the Childcare section
fit.models.and.plot(Gender.Roles.Plotting, 'Childcare', 50)
```

Rename to something to do with map or region

```{r, cache=TRUE}
region.weighted.differences <- function(Data) {
    Gender.Roles.Differences <- data.frame('Year' = c(), 'Variable' = c(), 'Generation' = c(), 'Difference' = c())
    for (variable in c("Working", "House.Maintenance", "Vehicle.Maintenance", "Housework", "Food.Preparation", "Childcare")) {
        for (generation in c("Silent Generation", "Baby Boomers", "Generation X", "Millennials")) {
            for (year in unique(Data$TUYEAR)) {
                for (region in 1:4) {
                    for (sex in c("M", "F")) {
                        Filtered.Data <- filter(Data, TESEX == sex, TUYEAR == year, TUGENERATION == generation, GEREG == region)
                        bottom.sum <- sum(Filtered.Data$TUFNWGTP)
                        top.sum <- sum(Filtered.Data$TUFNWGTP * Filtered.Data[,variable])
                        weighted.values <- top.sum / bottom.sum
                        if (sex == 'M') m.weighted.values <- weighted.values
                    }
                    weighted.difference <- m.weighted.values - weighted.values
                    Gender.Roles.Differences <- rbind(Gender.Roles.Differences, data.frame('Year' = year, 'Variable' = variable, 'Generation' = generation, 'Difference' = unique(weighted.difference)))
                }
            }
        }
    }
    return(Gender.Roles.Differences)
}

Gender.Roles.Differences.Region.Train <- region.weighted.differences(Gender.Roles.Train)
Gender.Roles.Differences.Region.Validate <- region.weighted.differences(Gender.Roles.Validate)
Gender.Roles.Differences.Region.Plotting <- region.weighted.differences(Gender.Roles.Plotting)
```

Code for running $t$-tests

```{r, cache=TRUE}
Gender.Roles.Differences.Validate <- filter(Gender.Roles.Differences, Month %% 2 != 0)
for (variable in c("Working", "House.Maintenance", "Vehicle.Maintenance", "Housework", "Food.Preparation", "Childcare")) {
    filter(Gender.Roles.Differences, 'Variable' == variable)
    model <- lm(data=Gender.Roles.Differences.Validate, Difference ~ Year)
    summary <- summary(model)
    print(summary)
    Year_t <- coefficients(summary)[2,3]
    lm_p_value <- pt(Year_t, model$df, lower=TRUE)
    print(lm_p_value)
}
```